import{r as u,u as _,A as b,R as J,j as t,D as K,T as $,B as y,I as U,C as X,F as Z,a as q,b as Q,G as S,P as w,e as d,M as H,g as ee,p as te,l as oe,S as ne}from"./index-5a3badb5.js";import{u as ie,c as se,M as ae,N as le,G as re,a as ce,b as C}from"./styles-12501ca3.js";const ue={}.VITE_GEOAPIFY_KEY,de={width:500,height:400,latitude:0,longitude:0,zoom:3},me=T=>{const{open:E,onClose:h,onUpdate:B,annonceId:f}=T,D=!0,L=ie(),W="lg",v=u.useRef(),{userToken:p}=_(),[F,P]=u.useState({titre:"",description:"",prix:0,voiture:0,latitude:0,longitude:0,address:""}),[o,g]=u.useState({longitude:0,latitude:0,zoom:2}),[j,G]=u.useState([]),[I,m]=u.useState(""),[M,R]=u.useState([]);u.useEffect(()=>{f&&b.getAnnonce(f,p).then(e=>e.json()).then(e=>{P(e),console.log(e),m(e.address),g({...o,longitude:e.longitude,latitude:e.latitude})}).catch(e=>console.log(e.message))},[f,o,p]);const k=()=>{h(!1),m(""),g({longitude:0,latitude:0,zoom:2})};u.useEffect(()=>{var e;o&&((e=v.current)==null||e.flyTo({center:[o.longitude,o.latitude],duration:2e3,zoom:14}))},[o]),u.useEffect(()=>{p&&b.listVoiture(p).then(e=>e.json()).then(e=>G(e)).catch(e=>console.log(e))},[p]),u.useEffect(()=>{if(o&&o.latitude!==0&&o.longitude!==0){const{longitude:e,latitude:a}=o;(async()=>{try{const i=await C.get(`https://api.geoapify.com/v1/geocode/reverse?lat=${a}&lon=${e}&apiKey=aedf3186d09b474abd1a8808eaf0bcc1`),{formatted:s}=i.data.features[0].properties;m(s)}catch(i){console.error(i)}})().catch(i=>console.log(i))}},[o]),u.useEffect(()=>{(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(a=>{const{latitude:l,longitude:i}=a.coords;g({...o,latitude:l,longitude:i})},a=>{console.log(a.message)}):console.log("Geolocation is not supported by your browser.")})()},[o]);const z=async e=>{const a=e.target.value;m(a);try{if(a.length>=3){const i=(await C.get(`https://api.geoapify.com/v1/geocode/autocomplete?text=${a}&limit=5&apiKey=${ue}`)).data.features.map(s=>({label:s.properties.formatted,latitude:s.properties.lat,longitude:s.properties.lon}));R(i)}}catch(l){console.error(l)}},N=J.useCallback(e=>{e&&e.trigger()},[]);return t.jsxs(K,{fullScreen:!0,open:E,onClose:k,TransitionComponent:$,fullWidth:D,maxWidth:W,className:L.dialog,children:[t.jsx(y,{sx:{m:2},children:t.jsx(U,{onClick:()=>h(!1),sx:{borderRadius:2},children:t.jsx(X,{})})}),t.jsx(Z,{initialValues:{titre:"",description:"",prix:0,voiture:0,latitude:0,longitude:0,address:"",...F},validationSchema:se,onSubmit:console.log,children:({values:e,handleChange:a,handleBlur:l,errors:i,touched:s,isValid:V,handleReset:O})=>t.jsxs(q,{method:"post",onSubmit:n=>{n.preventDefault();const r=new FormData(n.currentTarget),x={};for(const[c,A]of r.entries())c==="prix"?x[c]=parseInt(A.toString()):x[c]=A;x.latitude=o.latitude,x.longitude=o.longitude;const Y=JSON.stringify(x);b.updateAnnonce(f,Y,p).then(c=>c.json()).then(c=>{console.log(c),B(c),O(n)}).catch(c=>{console.log(c.message),console.log(c)}).finally(()=>h(!1))},children:[t.jsx(Q,{variant:"h2",textAlign:"center",sx:{fontSize:"3rem"},children:"Metre ajour l'annonce"}),t.jsxs(S,{sx:{display:"flex",alignItems:"center",justifyContent:"center",gap:5,flexDirection:"row",width:"100%",mt:5},container:!0,p:3,children:[t.jsxs(S,{md:5,sm:12,xs:12,item:!0,sx:{display:"flex",gap:1,flexDirection:"column",alignItems:"flex-start"},component:w,p:1,children:[t.jsx(d,{label:"Titre",name:"titre",value:e.titre,onChange:a("titre"),onBlur:l("titre"),error:!!(s.titre&&i.titre),helperText:s.titre&&i.titre.toString(),fullWidth:!0}),t.jsx(d,{label:"Voiture",name:"voiture",value:e.voiture,onChange:a("voiture"),onBlur:l("voiture"),error:!!(s.voiture&&i.voiture),helperText:s.voiture&&i.voiture.toString(),fullWidth:!0,select:!0,children:j==null?void 0:j.map(n=>{var r;return t.jsxs(H,{value:n.id,children:[(r=n.model.marque)==null?void 0:r.nom," ",n.model.nom," ",n.type_carburant," ",n.annee]},n.id)})}),t.jsx(d,{label:"Prix",InputProps:{startAdornment:t.jsx(ee,{position:"start",children:"XAF"})},name:"prix",type:"number",value:e.prix,onChange:a("prix"),onBlur:l("prix"),error:!!(s.prix&&i.prix),helperText:s.prix&&i.prix.toString(),fullWidth:!0}),t.jsx(d,{label:"Description",multiline:!0,rows:4,name:"description",value:e.description,onChange:a("description"),onBlur:l("description"),error:!!(s.description&&i.description),helperText:s.description&&i.description.toString(),fullWidth:!0}),t.jsx(te,{freeSolo:!0,options:M,getOptionLabel:n=>n.label,inputValue:I,onInputChange:n=>{z(n).catch(r=>console.log(r))},onChange:(n,r)=>{m(r?r.label:""),g({...o,longitude:r.longitude,latitude:r.latitude})},fullWidth:!0,renderInput:n=>t.jsx(d,{...n,name:"address",label:"Address",variant:"outlined"})}),t.jsxs(y,{style:{width:"100%",display:"flex",gap:5},children:[t.jsx(d,{label:"Latitude",name:"latitude",value:o.latitude,disabled:!0,fullWidth:!0,onChange:a("latitude"),onBlur:l("latitude"),error:!!(s.latitude&&i.latitude),helperText:s.latitude&&i.latitude.toString()}),t.jsx(d,{label:"Longitude",name:"longitude",value:o.longitude,disabled:!0,fullWidth:!0,onChange:a("longitude"),onBlur:l("longitude"),error:!!(s.longitude&&i.longitude),helperText:s.longitude&&i.longitude.toString()})]}),t.jsx(y,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"},children:t.jsx(oe,{startIcon:t.jsx(ne,{}),size:"large",color:"success",variant:"contained",type:"submit",disabled:!V&&I===""||o.latitude===0||o.longitude===0,children:"Mettre a jour"})})]}),t.jsx(S,{md:5,sm:12,xs:12,item:!0,component:w,children:t.jsxs(ae,{ref:v,initialViewState:de,style:{width:"100%",height:500},mapStyle:"mapbox://styles/mapbox/streets-v9",mapboxAccessToken:"pk.eyJ1IjoiaXZhbnRvbSIsImEiOiJjbDJnMGlwNnYwZm9zM2duYnQ0a3c2bXFvIn0.x29uaFl79xgLW6nCs15JWw",children:[t.jsx(le,{}),t.jsx(re,{showAccuracyCircle:!0,showUserLocation:!0,ref:N,onGeolocate:n=>g({...o,longitude:n.coords.longitude,latitude:n.coords.latitude})}),t.jsx(ce,{onDragEnd:n=>g({...o,latitude:n.lngLat.lat,longitude:n.lngLat.lng}),draggable:!0,longitude:o.longitude,latitude:o.latitude,anchor:"bottom"})]})})]})]})})]})};export{me as default};
